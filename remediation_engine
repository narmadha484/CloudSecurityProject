import boto3

def auto_fix(finding):
    """
    Decides and applies auto-remediation based on issue type.
    """
    issue = finding["issue"]
    service = finding["service"]

    if service == "IAM" and issue == "IAM user without MFA":
        return fix_iam_mfa(finding)

    elif service == "EC2" and issue == "Port 22 open to world (0.0.0.0/0)":
        return fix_ec2_ssh(finding)

    elif service == "EC2" and issue == "Instance has public IP":
        return "SKIPPED: Manual review required"

    elif service == "EC2" and issue == "EBS volume not encrypted":
        return "SKIPPED: Requires snapshot & recreate volume"

    else:
        return "NO AUTO-FIX AVAILABLE"


def fix_iam_mfa(finding):
    """
    IAM MFA cannot be forced programmatically.
    """
    return "MANUAL ACTION REQUIRED: Enable MFA for IAM user"

def fix_ec2_ssh(finding):
    ec2 = boto3.client("ec2")

    sg_id = finding["security_group_id"]
    my_ip = finding["my_ip"] + "/32"

    try:
        # Revoke open SSH access
        ec2.revoke_security_group_ingress(
            GroupId=sg_id,
            IpPermissions=[
                {
                    "IpProtocol": "tcp",
                    "FromPort": 22,
                    "ToPort": 22,
                    "IpRanges": [{"CidrIp": "0.0.0.0/0"}]
                }
            ]
        )

        # Add restricted SSH rule
        ec2.authorize_security_group_ingress(
            GroupId=sg_id,
            IpPermissions=[
                {
                    "IpProtocol": "tcp",
                    "FromPort": 22,
                    "ToPort": 22,
                    "IpRanges": [{"CidrIp": my_ip}]
                }
            ]
        )

        return f"FIXED: SSH restricted to {my_ip}"

    except Exception as e:
        return f"ERROR: {str(e)}"

